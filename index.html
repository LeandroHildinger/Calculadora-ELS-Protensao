<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora ELS - Elemento Protendido (Refatorada)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos gerais e de input */
        body { font-family: 'Inter', sans-serif; @apply bg-gray-50; }
        input[type=number] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .input-label { /* Estilo para labels que ficam ACIMA do input */
            @apply block text-sm font-medium text-gray-700 mb-1; 
        }
        .input-label-horizontal { /* Para labels AO LADO do input */
            @apply text-sm font-medium text-gray-700 whitespace-nowrap; 
        }

        .input-field { 
            @apply block w-full min-w-[5rem] px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm placeholder-gray-400; 
        }
        .input-field-calculated { 
            @apply block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm text-gray-600; 
        }
        
        /* Estilos de tabela */
        .table-sticky-header th { @apply sticky top-0 z-10; }
        .table-header { @apply px-4 py-2 bg-gray-100 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-300; }
        .table-cell { @apply px-4 py-2 whitespace-nowrap text-sm text-gray-800 border-b border-gray-200; }
        .table-cell-input { @apply w-full min-w-[4rem] px-1 py-0.5 bg-gray-50 border border-transparent focus:bg-white focus:border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-indigo-500 text-right; }
        .table-cell-output { @apply w-full px-1 py-0.5 bg-white text-right; }
        
        /* Estilos de verificação */
        .verification-ok { color: #16a34a; font-weight: 600; }
        .verification-fail { color: #dc2626; font-weight: 600; }
        .results-table td, .results-table th { @apply border border-gray-200; }
        
        /* Estilos de seção e visualização */
        .section-title { @apply text-lg font-semibold text-gray-800 mb-4 border-b border-gray-300 pb-2; }
        .subsection-title { @apply text-md font-medium text-gray-700 mb-3; }
        #section-visualization-container { @apply w-full aspect-square bg-gray-100 border border-gray-300 rounded-md mb-6 overflow-hidden relative; }
        #section-visualization { @apply w-full h-full flex items-center justify-center text-gray-500; }
        .element-number { font-size: 12px; font-weight: bold; font-family: monospace; fill: #4b5563; text-anchor: start; dominant-baseline: middle; }
        .cg-label { font-size: 10px; font-family: monospace; }
        .dimension-line { stroke: #9ca3af; stroke-width: 1; stroke-dasharray: 2,2; }
        .dimension-text { font-size: 10px; fill: #6b7280; text-anchor: middle; }
        
        /* Estilos para Abas */
        .tab-button { @apply px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 transition duration-150 ease-in-out focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500; }
        .tab-button-active { @apply border-indigo-500 text-indigo-600 bg-white; }
        .tab-button-inactive { @apply border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300; }
        .tab-content { @apply p-6 bg-white border border-t-0 border-gray-200 rounded-b-lg; }
        
        /* Estilos Botões Navegação */
        .nav-buttons { @apply flex justify-between mt-6; }
        .nav-button { @apply px-6 py-2 rounded-md text-sm font-medium shadow-sm focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-1 disabled:opacity-50 disabled:cursor-not-allowed; }
        .nav-button-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
        .nav-button-secondary { @apply bg-white text-gray-700 border border-gray-300 hover:bg-gray-50; }
        
        /* Card Style */
        .card { @apply bg-white p-4 rounded-xl shadow border border-gray-300; }
        
        /* Observações */
        .observations { @apply bg-yellow-100 border border-yellow-300 text-yellow-800 p-4 rounded-lg text-sm space-y-2 leading-5; }
        
        /* Botões +/- */
        .add-remove-button { @apply w-9 h-9 flex items-center justify-center bg-white text-gray-600 border border-gray-300 rounded-md shadow-sm hover:bg-gray-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-1; }
        
        /* Estilo para subscrito menor */
        .results-table sub, .input-label sub, .input-label-horizontal sub, #tab-content-acoes sub { font-size: 0.75em; vertical-align: sub; }
        
        /* Footer para Créditos */
        .app-footer { @apply mt-8 pt-4 border-t border-gray-200 text-left; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-xl border border-gray-200">
        <header class="text-center mb-8">
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Calculadora de Tensões em Serviço (ELS)</h1>
            <p class="text-base text-gray-600">Elemento Estrutural Protendido</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <section id="input-section" class="lg:col-span-2">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button id="tab-btn-geometria" type="button" class="tab-button tab-button-active" onclick="changeTab('geometria')">1. Geometria</button>
                        <button id="tab-btn-materiais" type="button" class="tab-button tab-button-inactive" onclick="changeTab('materiais')">2. Materiais e Protensão</button>
                        <button id="tab-btn-acoes" type="button" class="tab-button tab-button-inactive" onclick="changeTab('acoes')">3. Ações e Coeficientes</button>
                    </nav>
                </div>

                <div id="tab-content-container">
                    <div id="tab-content-geometria" class="tab-content">
                        <h3 class="subsection-title">1.1 Viga Pré-Moldada</h3>
                        <div class="overflow-x-auto mb-4">
                            <table id="geometry-table" class="min-w-full border border-gray-300 table-fixed w-full">
                                <thead class="table-sticky-header">
                                    <tr>
                                        <th class="table-header w-16">Elem.</th>
                                        <th class="table-header">B inf. (m)</th>
                                        <th class="table-header">B sup. (m)</th>
                                        <th class="table-header">h (m)</th>
                                        <th class="table-header">Área (m²)</th>
                                    </tr>
                                </thead>
                                <tbody id="geometry-tbody"></tbody>
                            </table>
                        </div>
                        <div class="flex justify-start space-x-2 mb-4">
                            <button id="add-row-btn" title="Adicionar Elemento" class="add-remove-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="remove-row-btn" title="Remover Último Elemento" class="add-remove-button">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <h3 class="subsection-title mt-6">1.2 Laje/Capa (Composta)</h3>
                        <div class="space-y-4 bg-gray-50 p-4 rounded-lg border">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-2">Laje Pré (1ª Camada):</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                                    <div class="flex items-center gap-[1ch]">
                                        <label for="bf1" class="input-label-horizontal">Largura (b<sub>f1</sub>) (m)</label>
                                        <input type="number" id="bf1" name="bf1" step="0.01" class="input-field flex-grow" value="1.00" placeholder="m" min="0">
                                    </div>
                                    <div class="flex items-center gap-[1ch]">
                                        <label for="hf1" class="input-label-horizontal">Altura (h<sub>f1</sub>) (m)</label>
                                        <input type="number" id="hf1" name="hf1" step="0.01" class="input-field flex-grow" value="0.11" placeholder="m" min="0">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mt-4 mb-2">Capa Conc. (2ª Camada):</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                                    <div class="flex items-center gap-[1ch]">
                                        <label for="bf2" class="input-label-horizontal">Largura (b<sub>f2</sub>) (m)</label>
                                        <input type="number" id="bf2" name="bf2" step="0.001" class="input-field flex-grow" value="4.250" placeholder="m" min="0">
                                    </div>
                                    <div class="flex items-center gap-[1ch]">
                                        <label for="hf2" class="input-label-horizontal">Altura (h<sub>f2</sub>) (m)</label>
                                        <input type="number" id="hf2" name="hf2" step="0.01" class="input-field flex-grow" value="0.14" placeholder="m" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-content-materiais" class="tab-content hidden">
                        <h3 class="subsection-title">2.1 Concreto</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-4 gap-y-4 mb-6 bg-gray-50 p-4 rounded-lg border">
                            <div><label for="fckj_ato" class="input-label">f<sub>ck,j</sub> (ATO) (tf/m²)</label><input type="number" id="fckj_ato" name="fckj_ato" step="10" class="input-field" value="3500" placeholder="tf/m²"></div>
                            <div><label for="fckj_servico" class="input-label">f<sub>ck,j</sub> (Serviço) (tf/m²)</label><input type="number" id="fckj_servico" name="fckj_servico" step="10" class="input-field" value="3500" placeholder="tf/m²"></div>
                            <div><label for="fck28" class="input-label">f<sub>ck</sub> (28d) (tf/m²)</label><input type="number" id="fck28" name="fck28" step="10" class="input-field" value="4500" placeholder="tf/m²"></div>
                            <div><label for="alpha" class="input-label">α (Alfa)</label><input type="number" id="alpha" name="alpha" step="0.1" class="input-field" value="1.2" placeholder="1.0, 1.2 ou 1.5"></div>
                        </div>
                        <h3 class="subsection-title">2.2 Protensão</h3>
                        <div class="space-y-6 bg-gray-50 p-4 rounded-lg border">
                            <div>
                                <p class="text-md font-medium text-gray-700 mb-3">Protensão - Etapa 1:</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                                    <div class="flex items-center gap-[1ch]"><label for="cg_cables1" class="input-label-horizontal">CG Cabos (m)</label><input type="number" id="cg_cables1" name="cg_cables1" step="0.001" class="input-field prestress-input flex-grow" value="0.209" placeholder="m"></div>
                                    <div class="flex items-center gap-[1ch]"><label for="num_cables1" class="input-label-horizontal">Nº Cabos (unid.)</label><input type="number" id="num_cables1" name="num_cables1" step="1" class="input-field prestress-input flex-grow" value="46" placeholder="unid."></div>
                                    <div class="flex items-center gap-[1ch]"><label for="po1" class="input-label-horizontal">P<sub>o</sub> (tf/cabo)</label><input type="number" id="po1" name="po1" step="0.1" class="input-field prestress-input flex-grow" value="21.1" placeholder="tf/cabo"></div>
                                    <div class="flex items-center gap-[1ch]"><label for="pinf1" class="input-label-horizontal">P<sub>∞</sub> (tf/cabo)</label><input type="number" id="pinf1" name="pinf1" step="0.1" class="input-field prestress-input flex-grow" value="17.8" placeholder="tf/cabo"></div>
                                    <div class="sm:col-span-2 flex items-center gap-[1ch]"><label for="ato_percentage" class="input-label-horizontal">% P<sub>o</sub> (ATO) (%)</label><input type="number" id="ato_percentage" name="ato_percentage" step="1" min="0" max="100" class="input-field flex-grow" value="100" placeholder="%"></div>
                                </div>
                            </div>
                            <hr class="border-gray-200">
                            <div>
                                <p class="text-md font-medium text-gray-700 mb-3">Protensão - Etapa 2:</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-4">
                                    <div class="flex items-center gap-[1ch]"><label for="cg_cables2" class="input-label-horizontal">CG Cabos (m)</label><input type="number" id="cg_cables2" name="cg_cables2" step="0.001" class="input-field prestress-input flex-grow" value="0.0" placeholder="m"></div>
                                    <div class="flex items-center gap-[1ch]"><label for="num_cables2" class="input-label-horizontal">Nº Cabos (unid.)</label><input type="number" id="num_cables2" name="num_cables2" step="1" class="input-field prestress-input flex-grow" value="0" placeholder="unid."></div>
                                    <div class="flex items-center gap-[1ch]"><label for="po2" class="input-label-horizontal">P<sub>o</sub> (tf/cabo)</label><input type="number" id="po2" name="po2" step="0.1" class="input-field prestress-input flex-grow" value="0.0" placeholder="tf/cabo"></div>
                                    <div class="flex items-center gap-[1ch]"><label for="pinf2" class="input-label-horizontal">P<sub>∞</sub> (tf/cabo)</label><input type="number" id="pinf2" name="pinf2" step="0.1" class="input-field prestress-input flex-grow" value="0.0" placeholder="tf/cabo"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-content-acoes" class="tab-content hidden">
                        <h3 class="subsection-title">3.1 Momentos Solicitantes (tf.m)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 bg-gray-50 p-4 rounded-lg border mb-6">
                            <div class="flex items-center gap-[1ch]"><label for="mg1" class="input-label-horizontal">M<sub>g1</sub></label><input type="number" id="mg1" name="mg1" step="0.1" class="input-field flex-grow" value="377.0"></div>
                            <div class="flex items-center gap-[1ch]"><label for="mg2" class="input-label-horizontal">M<sub>g2</sub></label><input type="number" id="mg2" name="mg2" step="0.1" class="input-field flex-grow" value="412.0"></div>
                            <div class="flex items-center gap-[1ch]"><label for="mg3" class="input-label-horizontal">M<sub>g3</sub></label><input type="number" id="mg3" name="mg3" step="0.1" class="input-field flex-grow" value="203.0"></div>
                            <div class="flex items-center gap-[1ch]"><label for="mq" class="input-label-horizontal">M<sub>q</sub></label><input type="number" id="mq" name="mq" step="0.1" class="input-field flex-grow" value="557.0"></div>
                            <div class="flex items-center gap-[1ch]"><label for="mp1o" class="input-label-horizontal">M<sub>p1o</sub> (calc.)</label><input type="number" id="mp1o" class="input-field-calculated flex-grow" readonly></div>
                            <div class="flex items-center gap-[1ch]"><label for="mp2o" class="input-label-horizontal">M<sub>p2o</sub> (calc.)</label><input type="number" id="mp2o" class="input-field-calculated flex-grow" readonly></div>
                            <div class="flex items-center gap-[1ch]"><label for="mp1oo" class="input-label-horizontal">M<sub>p1∞</sub> (calc.)</label><input type="number" id="mp1oo" class="input-field-calculated flex-grow" readonly></div>
                            <div class="flex items-center gap-[1ch]"><label for="mp2oo" class="input-label-horizontal">M<sub>p2∞</sub> (calc.)</label><input type="number" id="mp2oo" class="input-field-calculated flex-grow" readonly></div>
                        </div>

                        <h3 class="subsection-title">3.2 Esforços Normais Solicitantes (tf)</h3>
                        <p class="text-xs text-gray-500 mb-3">Informe os esforços normais externos (Compressão negativa, Tração positiva).</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 bg-gray-50 p-4 rounded-lg border mb-6">
                            <div class="flex items-center gap-[1ch]"><label for="ng1" class="input-label-horizontal">N<sub>g1</sub></label><input type="number" id="ng1" name="ng1" step="0.1" class="input-field flex-grow" value="0.0" placeholder="tf"></div>
                            <div class="flex items-center gap-[1ch]"><label for="ng2" class="input-label-horizontal">N<sub>g2</sub></label><input type="number" id="ng2" name="ng2" step="0.1" class="input-field flex-grow" value="0.0" placeholder="tf"></div>
                            <div class="flex items-center gap-[1ch]"><label for="ng3" class="input-label-horizontal">N<sub>g3</sub></label><input type="number" id="ng3" name="ng3" step="0.1" class="input-field flex-grow" value="0.0" placeholder="tf"></div>
                            <div class="flex items-center gap-[1ch]"><label for="nq" class="input-label-horizontal">N<sub>q</sub></label><input type="number" id="nq" name="nq" step="0.1" class="input-field flex-grow" value="0.0" placeholder="tf"></div>
                            <div class="flex items-center gap-[1ch]"><label for="np1o" class="input-label-horizontal">N<sub>p1o</sub> (calc.)</label><input type="number" id="np1o" class="input-field-calculated flex-grow" readonly></div>
                            <div class="flex items-center gap-[1ch]"><label for="np2o" class="input-label-horizontal">N<sub>p2o</sub> (calc.)</label><input type="number" id="np2o" class="input-field-calculated flex-grow" readonly></div>
                            <div class="flex items-center gap-[1ch]"><label for="np1oo" class="input-label-horizontal">N<sub>p1∞</sub> (calc.)</label><input type="number" id="np1oo" class="input-field-calculated flex-grow" readonly></div>
                            <div class="flex items-center gap-[1ch]"><label for="np2oo" class="input-label-horizontal">N<sub>p2∞</sub> (calc.)</label><input type="number" id="np2oo" class="input-field-calculated flex-grow" readonly></div>
                        </div>
                        <h3 class="subsection-title">3.3 Coeficientes (ψ)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 bg-gray-50 p-4 rounded-lg border">
                            <div class="flex items-center gap-[1ch]"><label for="psi1" class="input-label-horizontal">ψ<sub>1</sub></label><input type="number" id="psi1" name="psi1" step="0.01" class="input-field flex-grow" value="0.50"></div>
                            <div class="flex items-center gap-[1ch]"><label for="psi2" class="input-label-horizontal">ψ<sub>2</sub></label><input type="number" id="psi2" name="psi2" step="0.01" class="input-field flex-grow" value="0.30"></div>
                        </div>
                    </div>
                </div>

                <div class="nav-buttons">
                    <button id="prev-btn" type="button" class="nav-button nav-button-secondary" onclick="changeStep(-1)" disabled>‹ Voltar</button>
                    <button id="next-btn" type="button" class="nav-button nav-button-primary" onclick="changeStep(1)">Próximo ›</button>
                </div>
                <footer class="app-footer">
                    <p class="text-sm text-gray-500">Desenvolvido por: Leandro Hildinger Cavalcanti</p>
                    <p class="text-sm mt-2">
                        <a href="manual.md" target="_blank" class="text-indigo-600 hover:underline">Ver Manual de Uso</a>
                    </p>
                </footer>
            </section>

            <aside class="lg:col-span-1">
                <h2 class="section-title">Visualização da Seção</h2>
                <div id="section-visualization-container"> <div id="section-visualization">
                    <span class="text-sm italic">Visualização da seção aparecerá aqui</span>
                </div>
                </div>
                <h2 class="section-title">Observações</h2>
                <div class="observations">
                    <p><strong>a)</strong> Os elementos da viga são inseridos de baixo para cima.</p>
                    <p><strong>b)</strong> A protensão 2 é introduzida após o carregamento G2.</p>
                    <p><strong>c)</strong> Critério de tensões segue NBR 6118:2023 - Item 17.2.4.3.2 (a).</p>
                    <p><strong>d)</strong> A verificação 0 (ATO) considera a porcentagem de P<sub>o</sub> definida acima.</p>
                    <p><strong>Convenção:</strong> Compressão (-), Tração (+).</p>
                </div>
                <div class="mt-8 flex justify-center lg:justify-start">
                    <button id="calculate-btn" class="w-full lg:w-auto px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
                        Calcular Tensões
                    </button>
                </div>
            </aside>
        </div>

        <section id="results-section" class="mt-10 pt-6 border-t border-gray-300 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Resultados</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card"> <h3 class="text-lg font-semibold text-gray-700 mb-3">Propriedades Geométricas</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full results-table">
                            <thead>
                                <tr>
                                    <th class="table-header">Característica</th>
                                    <th class="table-header">Inicial</th>
                                    <th class="table-header">Final</th>
                                    <th class="table-header text-center w-16">Unid.</th>
                                </tr>
                            </thead>
                            <tbody id="properties-tbody">
                                <tr><td class="table-cell">Área</td><td id="area-inicial" class="table-cell text-right"></td><td id="area-final" class="table-cell text-right"></td><td class="table-cell text-center">m²</td></tr>
                                <tr><td class="table-cell">Y<sub>inf</sub></td><td id="yinf-inicial" class="table-cell text-right"></td><td id="yinf-final" class="table-cell text-right"></td><td class="table-cell text-center">m</td></tr>
                                <tr><td class="table-cell">Y<sub>sup (viga)</sub></td><td id="ysup-inicial" class="table-cell text-right"></td><td class="table-cell text-right">-</td><td class="table-cell text-center">m</td></tr>
                                <tr><td class="table-cell">Y<sub>sup (total)</sub></td><td class="table-cell text-right">-</td><td id="ysup-final" class="table-cell text-right"></td><td class="table-cell text-center">m</td></tr>
                                <tr><td class="table-cell">Inércia</td><td id="inercia-inicial" class="table-cell text-right"></td><td id="inercia-final" class="table-cell text-right"></td><td class="table-cell text-center">m⁴</td></tr>
                                <tr><td class="table-cell">W<sub>inf</sub></td><td id="winf-inicial" class="table-cell text-right"></td><td id="winf-final" class="table-cell text-right"></td><td class="table-cell text-center">m³</td></tr>
                                <tr><td class="table-cell">W<sub>sup1</sub></td><td id="wsup1-inicial" class="table-cell text-right"></td><td id="wsup1-final" class="table-cell text-right"></td><td class="table-cell text-center">m³</td></tr>
                                <tr><td class="table-cell">W<sub>sup2</sub></td><td id="wsup2-inicial" class="table-cell text-right"></td><td id="wsup2-final" class="table-cell text-right"></td><td class="table-cell text-center">m³</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card"> <h3 class="text-lg font-semibold text-gray-700 mb-3">Tensões Individuais por Ação (tf/m²)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full results-table">
                            <thead>
                                <tr>
                                    <th class="table-header">Ação</th>
                                    <th class="table-header">σ<sub>inf</sub></th>
                                    <th class="table-header">σ<sub>sup1</sub></th>
                                    <th class="table-header">σ<sub>sup2</sub></th>
                                </tr>
                            </thead>
                            <tbody id="individual-stresses-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card lg:col-span-1"> <h3 class="text-lg font-semibold text-gray-700 mb-3">Tensões Limites (tf/m²)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full results-table">
                            <thead>
                                <tr>
                                    <th class="table-header">Verif.</th>
                                    <th class="table-header">σ<sub>inf</sub></th>
                                    <th class="table-header">σ<sub>sup1</sub></th>
                                    <th class="table-header">σ<sub>sup2</sub></th>
                                </tr>
                            </thead>
                            <tbody id="limits-tbody">
                                <tr><td class="table-cell font-semibold">0 (ATO)</td><td id="limit-inf-0" class="table-cell text-right"></td><td id="limit-sup1-0" class="table-cell text-right"></td><td id="limit-sup2-0" class="table-cell text-right">-</td></tr>
                                <tr><td class="table-cell font-semibold">1 (ATO)</td><td id="limit-inf-1" class="table-cell text-right"></td><td id="limit-sup1-1" class="table-cell text-right"></td><td id="limit-sup2-1" class="table-cell text-right">-</td></tr>
                                <tr><td class="table-cell font-semibold">2 (Interm.)</td><td id="limit-inf-2" class="table-cell text-right"></td><td id="limit-sup1-2" class="table-cell text-right"></td><td id="limit-sup2-2" class="table-cell text-right">-</td></tr>
                                <tr><td class="table-cell font-semibold">3 (Interm.)</td><td id="limit-inf-3" class="table-cell text-right"></td><td id="limit-sup1-3" class="table-cell text-right">-</td><td id="limit-sup2-3" class="table-cell text-right"></td></tr>
                                <tr><td class="table-cell font-semibold">4 (ELS-F)</td><td id="limit-inf-4" class="table-cell text-right"></td><td id="limit-sup1-4" class="table-cell text-right">-</td><td id="limit-sup2-4" class="table-cell text-right"></td></tr>
                                <tr><td class="table-cell font-semibold">5 (ELS-D)</td><td id="limit-inf-5" class="table-cell text-right"></td><td id="limit-sup1-5" class="table-cell text-right">-</td><td id="limit-sup2-5" class="table-cell text-right"></td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card lg:col-span-1"> <h3 class="text-lg font-semibold text-gray-700 mb-3">Tensões Calculadas (tf/m²)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full results-table">
                            <thead>
                                <tr>
                                    <th class="table-header">Comb.</th>
                                    <th class="table-header">σ<sub>inf</sub></th>
                                    <th class="table-header">σ<sub>sup1</sub></th>
                                    <th class="table-header">σ<sub>sup2</sub></th>
                                    <th class="table-header">Verif.</th>
                                </tr>
                            </thead>
                            <tbody id="stresses-tbody">
                                <tr> <td class="table-cell font-semibold">0</td> <td id="stress-inf-0" class="table-cell text-right"></td> <td id="stress-sup1-0" class="table-cell text-right"></td> <td id="stress-sup2-0" class="table-cell text-right">-</td> <td id="check-0" class="table-cell text-center"></td> </tr>
                                <tr> <td class="table-cell font-semibold">1</td> <td id="stress-inf-1" class="table-cell text-right"></td> <td id="stress-sup1-1" class="table-cell text-right"></td> <td id="stress-sup2-1" class="table-cell text-right">-</td> <td id="check-1" class="table-cell text-center"></td> </tr>
                                <tr> <td class="table-cell font-semibold">2</td> <td id="stress-inf-2" class="table-cell text-right"></td> <td id="stress-sup1-2" class="table-cell text-right"></td> <td id="stress-sup2-2" class="table-cell text-right">-</td> <td id="check-2" class="table-cell text-center"></td> </tr>
                                <tr> <td class="table-cell font-semibold">3</td> <td id="stress-inf-3" class="table-cell text-right"></td> <td id="stress-sup1-3" class="table-cell text-right"></td> <td id="stress-sup2-3" class="table-cell text-right"></td> <td id="check-3" class="table-cell text-center"></td> </tr>
                                <tr> <td class="table-cell font-semibold">4</td> <td id="stress-inf-4" class="table-cell text-right"></td> <td id="stress-sup1-4" class="table-cell text-right"></td> <td id="stress-sup2-4" class="table-cell text-right"></td> <td id="check-4" class="table-cell text-center"></td> </tr>
                                <tr> <td class="table-cell font-semibold">5</td> <td id="stress-inf-5" class="table-cell text-right"></td> <td id="stress-sup1-5" class="table-cell text-right"></td> <td id="stress-sup2-5" class="table-cell text-right"></td> <td id="check-5" class="table-cell text-center"></td> </tr>
                            </tbody>
                        </table>
                        <p class="text-xs text-gray-500 mt-2 text-center">Combinações: 0,1: ATO; 2,3: Interm.; 4: ELS-F; 5: ELS-D</p>
                    </div>
                </div>

                <div class="card lg:col-span-2">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Momentos de Descompressão (tf.m)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full results-table">
                            <thead>
                                <tr>
                                    <th class="table-header">Descrição</th>
                                    <th class="table-header">Valor (tf.m)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="table-cell">M<sub>d,inicial</sub> (P<sub>0</sub>, Seção Inicial)</td>
                                    <td id="result-md-inicial" class="table-cell text-right"></td>
                                </tr>
                                <tr>
                                    <td class="table-cell">M<sub>d,final</sub> (P<sub>∞</sub>, Seção Final)</td>
                                    <td id="result-md-final" class="table-cell text-right"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

<script>
    // --- Constantes ---
    const TF_PER_KN = 9.80665;
    const KN_M2_TO_TF_M2 = 1 / TF_PER_KN;
    const TF_TO_KN = TF_PER_KN;

    // --- Variáveis Globais ---
    let currentStep = 1;
    const totalSteps = 3;

    // --- Elementos da Interface (cache) ---
    let geometryTbody, addRowBtn, removeRowBtn, calculateBtn, resultsSection, visualizationDiv;
    let tabButtons, stepContents, prevBtn, nextBtn;
    let indStresses = {}; // Tornar indStresses global para ser acessível por sumFiberStress na versão R02

    // --- Funções Auxiliares ---
    const getElement = (id) => document.getElementById(id);
    const querySelectorAll = (selector) => document.querySelectorAll(selector);
    const parseFloatInput = (id, defaultValue = 0) => parseFloat(getElement(id).value) || defaultValue;
    const parseIntInput = (id, defaultValue = 0) => parseInt(getElement(id).value) || defaultValue;
    const formatNumber = (value, decimals = 0, useDashForNull = true) => {
        if (value === null || value === undefined || isNaN(value)) {
            return useDashForNull ? '-' : '';
        }
        return value.toFixed(decimals);
    };
    const updateElementText = (id, value) => { getElement(id).textContent = value; };
    const updateElementValue = (id, value) => { getElement(id).value = value; };
    const safeGet = (obj, prop) => (obj && obj[prop] !== null && obj[prop] !== undefined) ? obj[prop] : 0;
    const flexStress = (moment, modulus) => (modulus > 1e-9 ? moment / modulus : 0);
    const axialStress = (force, area) => (area > 1e-9 ? force / area : 0);

    // --- Funções de Navegação ---
    function updateNavButtons() {
        prevBtn.disabled = currentStep === 1;
        nextBtn.disabled = currentStep === totalSteps;
    }

    function goToStep(stepNumber) {
        if (stepNumber < 1 || stepNumber > totalSteps) return;
        currentStep = stepNumber;
        tabButtons.forEach((button, index) => {
            button.classList.toggle('tab-button-active', index + 1 === currentStep);
            button.classList.toggle('tab-button-inactive', index + 1 !== currentStep);
        });
        stepContents.forEach((content, index) => {
            content.classList.toggle('hidden', index + 1 !== currentStep);
        });
        updateNavButtons();
    }

    function changeStep(direction) {
        goToStep(currentStep + direction);
    }

    function changeTab(targetTabId) {
        let targetStep = 1;
        if (targetTabId === 'materiais') targetStep = 2;
        else if (targetTabId === 'acoes') targetStep = 3;
        goToStep(targetStep);
    }

    // --- Funções de Geometria da Viga ---
    function addGeometryRow(binf = 0, bsup = 0, h = 0) {
        const rowCount = geometryTbody.rows.length;
        const row = geometryTbody.insertRow();
        row.innerHTML = `
            <td class="table-cell font-medium text-center">${rowCount + 1}</td>
            <td class="table-cell p-1"><input type="number" step="0.001" value="${formatNumber(binf, 3, false)}" class="table-cell-input geometry-input binf" min="0"></td>
            <td class="table-cell p-1"><input type="number" step="0.001" value="${formatNumber(bsup, 3, false)}" class="table-cell-input geometry-input bsup" min="0"></td>
            <td class="table-cell p-1"><input type="number" step="0.001" value="${formatNumber(h, 3, false)}" class="table-cell-input geometry-input h" min="0"></td>
            <td class="table-cell p-1"><input type="number" class="table-cell-output area" readonly></td>
        `;
        row.querySelectorAll('.geometry-input').forEach(input => {
            input.addEventListener('input', handleGeometryInputChange);
        });
        calculateRowArea({ target: row.querySelector('.geometry-input') });
    }

    function removeGeometryRow() {
        if (geometryTbody.rows.length > 1) {
            geometryTbody.deleteRow(-1);
            updatePrestressForcesAndMomentsInActionsUI();
            drawSection();
        }
    }

    function handleGeometryInputChange(event) {
        calculateRowArea(event);
        updatePrestressForcesAndMomentsInActionsUI();
        drawSection();
    }

    function calculateRowArea(event) {
        const row = event.target.closest('tr');
        if (!row) return;
        const binfInput = row.querySelector('.binf');
        const bsupInput = row.querySelector('.bsup');
        const hInput = row.querySelector('.h');
        const areaOutput = row.querySelector('.area');

        if (!binfInput || !bsupInput || !hInput || !areaOutput) return;

        const binf = parseFloat(binfInput.value) || 0;
        const bsup = parseFloat(bsupInput.value) || 0;
        const h = parseFloat(hInput.value) || 0;
        const area = (binf + bsup) / 2 * h;
        areaOutput.value = formatNumber(area, 3, false);
    }

    // --- Coleta de Dados de Entrada ---
    function getInputs() {
        const inputs = {
            geometry: [],
            bf1: parseFloatInput('bf1'), hf1: parseFloatInput('hf1'),
            bf2: parseFloatInput('bf2'), hf2: parseFloatInput('hf2'),
            fckj_ato_tfm2: parseFloatInput('fckj_ato'),
            fckj_servico_tfm2: parseFloatInput('fckj_servico'),
            fck28_tfm2: parseFloatInput('fck28'),
            alpha: parseFloatInput('alpha', 1.2),
            cg_cables1: parseFloatInput('cg_cables1'), num_cables1: parseIntInput('num_cables1'),
            po1_per_cable: parseFloatInput('po1'), pinf1_per_cable: parseFloatInput('pinf1'),
            ato_percentage: parseFloatInput('ato_percentage', 100),
            cg_cables2: parseFloatInput('cg_cables2'), num_cables2: parseIntInput('num_cables2'),
            po2_per_cable: parseFloatInput('po2'), pinf2_per_cable: parseFloatInput('pinf2'),
            mg1: parseFloatInput('mg1'), mg2: parseFloatInput('mg2'),
            mg3: parseFloatInput('mg3'), mq: parseFloatInput('mq'),
            ng1: parseFloatInput('ng1'), ng2: parseFloatInput('ng2'),
            ng3: parseFloatInput('ng3'), nq: parseFloatInput('nq'),
            psi1: parseFloatInput('psi1'), psi2: parseFloatInput('psi2')
        };

        geometryTbody.querySelectorAll('tr').forEach(row => {
            inputs.geometry.push({
                binf: parseFloat(row.querySelector('.binf').value) || 0,
                bsup: parseFloat(row.querySelector('.bsup').value) || 0,
                h: parseFloat(row.querySelector('.h').value) || 0,
                area: parseFloat(row.querySelector('.area').value) || 0
            });
        });

        inputs.Poo1_total_tf = inputs.po1_per_cable * inputs.num_cables1;
        inputs.Poo2_total_tf = inputs.po2_per_cable * inputs.num_cables2;
        inputs.Pinf1_total_tf = inputs.pinf1_per_cable * inputs.num_cables1;
        inputs.Pinf2_total_tf = inputs.pinf2_per_cable * inputs.num_cables2;

        inputs.fckj_ato_mpa = inputs.fckj_ato_tfm2 * TF_TO_KN / 1000;
        inputs.fckj_servico_mpa = inputs.fckj_servico_tfm2 * TF_TO_KN / 1000;
        inputs.fck28_mpa = inputs.fck28_tfm2 * TF_TO_KN / 1000;

        inputs.Poo1_total_kn = inputs.Poo1_total_tf * TF_TO_KN;
        inputs.Poo2_total_kn = inputs.Poo2_total_tf * TF_TO_KN;
        inputs.Pinf1_total_kn = inputs.Pinf1_total_tf * TF_TO_KN;
        inputs.Pinf2_total_kn = inputs.Pinf2_total_tf * TF_TO_KN;

        inputs.mg1_knm = inputs.mg1 * TF_TO_KN;
        inputs.mg2_knm = inputs.mg2 * TF_TO_KN;
        inputs.mg3_knm = inputs.mg3 * TF_TO_KN;
        inputs.mq_knm = inputs.mq * TF_TO_KN;

        inputs.ng1_kn = inputs.ng1 * TF_TO_KN;
        inputs.ng2_kn = inputs.ng2 * TF_TO_KN;
        inputs.ng3_kn = inputs.ng3 * TF_TO_KN;
        inputs.nq_kn = inputs.nq * TF_TO_KN;

        return inputs;
    }

    // --- Funções de Cálculo de Engenharia ---
    function calculateGeometricProperties(geometry, bf1, hf1, bf2, hf2) {
        let area_inicial = 0, static_moment_y_inicial = 0, inertia_elements_cg_inicial = 0;
        let h_total_inicial = 0, current_y_base = 0;

        geometry.forEach(el => {
            if (el.h > 0 && el.area > 0) {
                const el_cg_y = current_y_base + el.h / 2;
                area_inicial += el.area;
                static_moment_y_inicial += el.area * el_cg_y;
                let el_inertia_cg;
                if (Math.abs(el.binf - el.bsup) < 1e-9) { // Retangular
                    el_inertia_cg = el.binf * Math.pow(el.h, 3) / 12;
                } else { // Trapezoidal
                    el_inertia_cg = (Math.pow(el.h, 3) / 36.0) * (el.binf * el.binf + 4 * el.binf * el.bsup + el.bsup * el.bsup) / (el.binf + el.bsup);
                }
                inertia_elements_cg_inicial += el_inertia_cg;
                h_total_inicial += el.h;
                current_y_base += el.h;
            }
        });

        const y_inf_inicial = area_inicial > 1e-9 ? static_moment_y_inicial / area_inicial : 0;
        const y_sup_inicial = h_total_inicial - y_inf_inicial;

        let inertia_parallel_axis_inicial = 0;
        current_y_base = 0;
        geometry.forEach(el => {
            if (el.h > 0 && el.area > 0) {
                const el_cg_y = current_y_base + el.h / 2;
                const dist_cg_sq = Math.pow(el_cg_y - y_inf_inicial, 2);
                inertia_parallel_axis_inicial += el.area * dist_cg_sq;
                current_y_base += el.h;
            }
        });
        const inertia_total_inicial = inertia_elements_cg_inicial + inertia_parallel_axis_inicial;
        const w_inf_inicial = y_inf_inicial > 1e-9 ? inertia_total_inicial / y_inf_inicial : 0;
        const w_sup1_inicial = y_sup_inicial > 1e-9 ? inertia_total_inicial / y_sup_inicial : 0;

        const area_laje1 = bf1 * hf1;
        const area_laje2 = bf2 * hf2;
        const area_final = area_inicial + area_laje1 + area_laje2;

        const y_cg_laje1 = h_total_inicial + hf1 / 2;
        const y_cg_laje2 = h_total_inicial + hf1 + hf2 / 2;

        const static_moment_y_final = static_moment_y_inicial +
                                    (area_laje1 * y_cg_laje1) +
                                    (area_laje2 * y_cg_laje2);
        const y_inf_final = area_final > 1e-9 ? static_moment_y_final / area_final : 0;
        const h_total_final = h_total_inicial + hf1 + hf2;
        const y_sup_final = h_total_final - y_inf_final;

        const inertia_laje1_cg = bf1 * Math.pow(hf1, 3) / 12;
        const inertia_laje2_cg = bf2 * Math.pow(hf2, 3) / 12;

        const dist_cg_viga_final_sq = Math.pow(y_inf_inicial - y_inf_final, 2);
        const dist_cg_laje1_final_sq = area_laje1 > 1e-9 ? Math.pow(y_cg_laje1 - y_inf_final, 2) : 0;
        const dist_cg_laje2_final_sq = area_laje2 > 1e-9 ? Math.pow(y_cg_laje2 - y_inf_final, 2) : 0;

        const inertia_total_final = (inertia_total_inicial + area_inicial * dist_cg_viga_final_sq) +
                                  (inertia_laje1_cg + area_laje1 * dist_cg_laje1_final_sq) +
                                  (inertia_laje2_cg + area_laje2 * dist_cg_laje2_final_sq);

        const w_inf_final = y_inf_final > 1e-9 ? inertia_total_final / y_inf_final : 0;
        const y_sup1_final_dist = Math.abs(h_total_inicial - y_inf_final); 
        const w_sup1_final = y_sup1_final_dist > 1e-9 ? inertia_total_final / y_sup1_final_dist : 0;
        const w_sup2_final = y_sup_final > 1e-9 ? inertia_total_final / y_sup_final : 0; 

        return {
            inicial: { area: area_inicial, y_inf: y_inf_inicial, y_sup: y_sup_inicial, inertia: inertia_total_inicial, w_inf: w_inf_inicial, w_sup1: w_sup1_inicial, w_sup2: 0, h_total: h_total_inicial },
            final:   { area: area_final,   y_inf: y_inf_final,   y_sup: y_sup_final,   inertia: inertia_total_final,   w_inf: w_inf_final,   w_sup1: w_sup1_final,   w_sup2: w_sup2_final, h_total: h_total_final }
        };
    }

    function calculatePrestressForces(inputs) {
        return {
            Np1o: -inputs.Poo1_total_tf, Np2o: -inputs.Poo2_total_tf,
            Np1oo: -inputs.Pinf1_total_tf, Np2oo: -inputs.Pinf2_total_tf
        };
    }

    function calculatePrestressMoments(inputs, properties) {
        const { inicial: prop_i, final: prop_f } = properties;
        const e0_1_inicial = prop_i.y_inf - inputs.cg_cables1;
        const e0_1_final = prop_f.y_inf - inputs.cg_cables1; 
        const e0_2_inicial = prop_i.y_inf - inputs.cg_cables2;
        const e0_2_final = prop_f.y_inf - inputs.cg_cables2; 
        return {
            Mp1o: inputs.Poo1_total_tf * e0_1_inicial,
            Mp2o: inputs.Poo2_total_tf * e0_2_inicial, 
            Mp1oo: inputs.Pinf1_total_tf * e0_1_final, 
            Mp2oo: inputs.Pinf2_total_tf * e0_2_final  
        };
    }
    
    function calculateLimitStresses(inputs) {
        const { fckj_ato_mpa, fckj_servico_mpa, fck28_mpa, alpha } = inputs;
        const mpa_to_tfm2_factor = 1000 * KN_M2_TO_TF_M2;

        const fctm_ato_mpa = 0.3 * Math.pow(fckj_ato_mpa, 2/3);
        const fctm_servico_mpa = 0.3 * Math.pow(fckj_servico_mpa, 2/3); 

        const fctm_ato_tfm2 = fctm_ato_mpa * mpa_to_tfm2_factor;
        const fctm_servico_tfm2 = fctm_servico_mpa * mpa_to_tfm2_factor;

        const fckj_ato_tfm2_val = fckj_ato_mpa * mpa_to_tfm2_factor;
        const fck28_tfm2_val = fck28_mpa * mpa_to_tfm2_factor; 

        const limits = [
            { inf: -0.70 * fckj_ato_tfm2_val, sup1: alpha * fctm_ato_tfm2, sup2: null }, 
            { inf: -0.70 * fckj_ato_tfm2_val, sup1: alpha * fctm_ato_tfm2, sup2: null }, 
            { inf: fctm_servico_tfm2, sup1: -0.70 * fck28_tfm2_val, sup2: null },  
            { inf: -0.70 * fck28_tfm2_val, sup1: null, sup2: fctm_servico_tfm2 },         
            { inf: null, sup1: null, sup2: -0.60 * fck28_tfm2_val },                     
            { inf: 0, sup1: null, sup2: -0.45 * fck28_tfm2_val }                        
        ];
        limits[4].inf = limits[3].sup2; 
        return limits;
    }

    function calculateIndividualStresses(inputs, properties) {
        const { inicial: prop_i, final: prop_f } = properties;
        indStresses = {}; // Limpa/reinicia o objeto global indStresses

        indStresses.p1o_ax = {
            inf: axialStress(-inputs.Poo1_total_kn, prop_i.area),
            sup1: axialStress(-inputs.Poo1_total_kn, prop_i.area),
            sup2: null
        };
        const e0_1_i = prop_i.y_inf - inputs.cg_cables1;
        const M_p1o_knm = inputs.Poo1_total_kn * e0_1_i;
        indStresses.p1o_flex = {
            inf: -flexStress(M_p1o_knm, prop_i.w_inf),
            sup1: +flexStress(M_p1o_knm, prop_i.w_sup1),
            sup2: null
        };

        indStresses.p2o_ax = {
            inf: axialStress(-inputs.Poo2_total_kn, prop_i.area),
            sup1: axialStress(-inputs.Poo2_total_kn, prop_i.area),
            sup2: null
        };
        const e0_2_i = prop_i.y_inf - inputs.cg_cables2;
        const M_p2o_knm = inputs.Poo2_total_kn * e0_2_i;
        indStresses.p2o_flex = {
            inf: -flexStress(M_p2o_knm, prop_i.w_inf),
            sup1: +flexStress(M_p2o_knm, prop_i.w_sup1),
            sup2: null
        };
        
        const P0_1_kn = inputs.Poo1_total_kn;
        const Pinf_1_kn = inputs.Pinf1_total_kn;
        const delta_P1_kn = P0_1_kn - Pinf_1_kn; 
        const cg1 = inputs.cg_cables1;
        indStresses.p1oo_ax = { 
            inf:  axialStress(-P0_1_kn, prop_i.area) + axialStress(delta_P1_kn, prop_f.area),
            sup1: axialStress(-P0_1_kn, prop_i.area) + axialStress(delta_P1_kn, prop_f.area),
            sup2: axialStress(delta_P1_kn, prop_f.area) 
        };
        const exc_1_i = prop_i.y_inf - cg1;
        const exc_1_f = prop_f.y_inf - cg1;
        indStresses.p1oo_flex = {
            inf:  -flexStress(P0_1_kn * exc_1_i, prop_i.w_inf)   + flexStress(delta_P1_kn * exc_1_f, prop_f.w_inf),
            sup1: +flexStress(P0_1_kn * exc_1_i, prop_i.w_sup1) - flexStress(delta_P1_kn * exc_1_f, prop_f.w_sup1),
            sup2: -flexStress(delta_P1_kn * exc_1_f, prop_f.w_sup2)
        };

        const P0_2_kn = inputs.Poo2_total_kn;
        const Pinf_2_kn = inputs.Pinf2_total_kn;
        const delta_P2_kn = P0_2_kn - Pinf_2_kn; 
        const cg2 = inputs.cg_cables2;
        indStresses.p2oo_ax = { 
            inf:  axialStress(-P0_2_kn, prop_i.area) + axialStress(delta_P2_kn, prop_f.area),
            sup1: axialStress(-P0_2_kn, prop_i.area) + axialStress(delta_P2_kn, prop_f.area),
            sup2: axialStress(delta_P2_kn, prop_f.area)
        };
        const exc_2_i = prop_i.y_inf - cg2;
        const exc_2_f = prop_f.y_inf - cg2;
        indStresses.p2oo_flex = {
            inf:  -flexStress(P0_2_kn * exc_2_i, prop_i.w_inf)   + flexStress(delta_P2_kn * exc_2_f, prop_f.w_inf),
            sup1: +flexStress(P0_2_kn * exc_2_i, prop_i.w_sup1) - flexStress(delta_P2_kn * exc_2_f, prop_f.w_sup1),
            sup2: -flexStress(delta_P2_kn * exc_2_f, prop_f.w_sup2)
        };

        indStresses.ng1 = { inf: axialStress(inputs.ng1_kn, prop_i.area), sup1: axialStress(inputs.ng1_kn, prop_i.area), sup2: null };
        indStresses.mg1 = { inf: +flexStress(inputs.mg1_knm, prop_i.w_inf), sup1: -flexStress(inputs.mg1_knm, prop_i.w_sup1), sup2: null };
        indStresses.ng2 = { inf: axialStress(inputs.ng2_kn, prop_i.area), sup1: axialStress(inputs.ng2_kn, prop_i.area), sup2: null };
        indStresses.mg2 = { inf: +flexStress(inputs.mg2_knm, prop_i.w_inf), sup1: -flexStress(inputs.mg2_knm, prop_i.w_sup1), sup2: null };
        
        indStresses.ng3 = { inf: axialStress(inputs.ng3_kn, prop_f.area), sup1: axialStress(inputs.ng3_kn, prop_f.area), sup2: axialStress(inputs.ng3_kn, prop_f.area) };
        indStresses.mg3 = { inf: +flexStress(inputs.mg3_knm, prop_f.w_inf), sup1: -flexStress(inputs.mg3_knm, prop_f.w_sup1), sup2: -flexStress(inputs.mg3_knm, prop_f.w_sup2) };
        indStresses.nq = { inf: axialStress(inputs.nq_kn, prop_f.area), sup1: axialStress(inputs.nq_kn, prop_f.area), sup2: axialStress(inputs.nq_kn, prop_f.area) };
        indStresses.mq = { inf: +flexStress(inputs.mq_knm, prop_f.w_inf), sup1: -flexStress(inputs.mq_knm, prop_f.w_sup1), sup2: -flexStress(inputs.mq_knm, prop_f.w_sup2) };

        return indStresses; 
    }
    
    // Função calculateDecompressionMoments ajustada para usar tensões individuais
    function calculateDecompressionMoments(inputs, properties, individualStresses_knm2) {
        const { inicial: prop_i, final: prop_f } = properties;

        // Md,inicial (baseado nas tensões de P0 na fibra inferior da seção inicial)
        let sigma_inf_P0_kn = 0;
        sigma_inf_P0_kn += safeGet(individualStresses_knm2.p1o_ax, 'inf');
        sigma_inf_P0_kn += safeGet(individualStresses_knm2.p1o_flex, 'inf');
        if (inputs.num_cables2 > 0) { // Considerar P2o apenas se houver cabos na Etapa 2
            sigma_inf_P0_kn += safeGet(individualStresses_knm2.p2o_ax, 'inf');
            sigma_inf_P0_kn += safeGet(individualStresses_knm2.p2o_flex, 'inf');
        }
        
        const sigma_inf_P0_tfm2 = sigma_inf_P0_kn * KN_M2_TO_TF_M2;
        const Md1_tfm = (prop_i.w_inf > 1e-9 && sigma_inf_P0_tfm2 !== 0) ? (-sigma_inf_P0_tfm2) * prop_i.w_inf : 0;

        // Md,final (baseado nas tensões de P∞ na fibra inferior da seção final)
        let sigma_inf_Pinf_kn = 0;
        sigma_inf_Pinf_kn += safeGet(individualStresses_knm2.p1oo_ax, 'inf');
        sigma_inf_Pinf_kn += safeGet(individualStresses_knm2.p1oo_flex, 'inf');
        if (inputs.num_cables2 > 0) { // Considerar P2inf apenas se houver cabos na Etapa 2
             sigma_inf_Pinf_kn += safeGet(individualStresses_knm2.p2oo_ax, 'inf');
             sigma_inf_Pinf_kn += safeGet(individualStresses_knm2.p2oo_flex, 'inf');
        }

        const sigma_inf_Pinf_tfm2 = sigma_inf_Pinf_kn * KN_M2_TO_TF_M2;
        const Md2_tfm = (prop_f.w_inf > 1e-9 && sigma_inf_Pinf_tfm2 !== 0) ? (-sigma_inf_Pinf_tfm2) * prop_f.w_inf : 0;
        
        return { Md1_tfm, Md2_tfm };
    }


    const sumFiberStress = (fiber, stressSources) => {
        let totalStress = 0;
        stressSources.forEach(source => {
            const axialVal = safeGet(indStresses[source.ax], fiber); // indStresses é global
            const flexVal = safeGet(indStresses[source.flex], fiber); // indStresses é global
            const multiplier = source.multiplier !== undefined ? source.multiplier : 1.0;
            totalStress += (axialVal + flexVal) * multiplier;
        });
        return totalStress;
    };
    
    function calculateCombinedStressesAndVerifications(inputs, limits_tfm2) { 
        const results = [];
        const eta = inputs.ato_percentage / 100.0;

        // Verificação 0 (ATO: eta * 1.1 * P1o + G1) - Seção Inicial
        const stress0_inf_kn = sumFiberStress('inf', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'p1o_ax', flex: 'p1o_flex', multiplier: eta * 1.1 } ]);
        const stress0_sup1_kn = sumFiberStress('sup1', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'p1o_ax', flex: 'p1o_flex', multiplier: eta * 1.1 } ]);
        results.push({ inf: stress0_inf_kn * KN_M2_TO_TF_M2, sup1: stress0_sup1_kn * KN_M2_TO_TF_M2, sup2: null });

        // Verificação 1 (ATO: 1.1 * (P1o + P2o) + G1) - Seção Inicial
        const stress1_inf_kn = sumFiberStress('inf', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'p1o_ax', flex: 'p1o_flex', multiplier: 1.1 }, { ax: 'p2o_ax', flex: 'p2o_flex', multiplier: 1.1 } ]);
        const stress1_sup1_kn = sumFiberStress('sup1', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'p1o_ax', flex: 'p1o_flex', multiplier: 1.1 }, { ax: 'p2o_ax', flex: 'p2o_flex', multiplier: 1.1 } ]);
        results.push({ inf: stress1_inf_kn * KN_M2_TO_TF_M2, sup1: stress1_sup1_kn * KN_M2_TO_TF_M2, sup2: null });

        // Verificação 2 (Intermediária: P1o + G1 + G2) - Seção Inicial
        const stress2_inf_kn = sumFiberStress('inf', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'p1o_ax', flex: 'p1o_flex'} ]);
        const stress2_sup1_kn = sumFiberStress('sup1', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'p1o_ax', flex: 'p1o_flex'} ]);
        results.push({ inf: stress2_inf_kn * KN_M2_TO_TF_M2, sup1: stress2_sup1_kn * KN_M2_TO_TF_M2, sup2: null });

        // Verificação 3 (Intermediária: G1 + G2 + Po1 + Po2)
        const stress3_inf_kn = sumFiberStress('inf', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'p1o_ax', flex: 'p1o_flex'}, { ax: 'p2o_ax', flex: 'p2o_flex'} ]);
        const stress3_sup1_kn = sumFiberStress('sup1', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'p1o_ax', flex: 'p1o_flex'}, { ax: 'p2o_ax', flex: 'p2o_flex'} ]);
        const stress3_sup2_kn = 0; 
        results.push({ inf: stress3_inf_kn * KN_M2_TO_TF_M2, sup1: stress3_sup1_kn * KN_M2_TO_TF_M2, sup2: stress3_sup2_kn * KN_M2_TO_TF_M2 });


        // Verificação 4 (ELS-F: P1inf + P2inf + G1+G2+G3 + psi1*Q) - Seção Final
        const stress4_inf_kn = sumFiberStress('inf', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'ng3', flex: 'mg3'}, { ax: 'nq', flex: 'mq', multiplier: inputs.psi1}, { ax: 'p1oo_ax', flex: 'p1oo_flex'}, { ax: 'p2oo_ax', flex: 'p2oo_flex'} ]);
        const stress4_sup1_kn = sumFiberStress('sup1', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'ng3', flex: 'mg3'}, { ax: 'nq', flex: 'mq', multiplier: inputs.psi1}, { ax: 'p1oo_ax', flex: 'p1oo_flex'}, { ax: 'p2oo_ax', flex: 'p2oo_flex'} ]);
        const stress4_sup2_kn = sumFiberStress('sup2', [ { ax: 'ng3', flex: 'mg3'}, { ax: 'nq', flex: 'mq', multiplier: inputs.psi1}, { ax: 'p1oo_ax', flex: 'p1oo_flex'}, { ax: 'p2oo_ax', flex: 'p2oo_flex'} ]);
        results.push({ inf: stress4_inf_kn * KN_M2_TO_TF_M2, sup1: stress4_sup1_kn * KN_M2_TO_TF_M2, sup2: stress4_sup2_kn * KN_M2_TO_TF_M2 });

        // Verificação 5 (ELS-D: P1inf + P2inf + G1+G2+G3 + psi2*Q) - Seção Final
        const stress5_inf_kn = sumFiberStress('inf', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'ng3', flex: 'mg3'}, { ax: 'nq', flex: 'mq', multiplier: inputs.psi2}, { ax: 'p1oo_ax', flex: 'p1oo_flex'}, { ax: 'p2oo_ax', flex: 'p2oo_flex'} ]);
        const stress5_sup1_kn = sumFiberStress('sup1', [ { ax: 'ng1', flex: 'mg1'}, { ax: 'ng2', flex: 'mg2'}, { ax: 'ng3', flex: 'mg3'}, { ax: 'nq', flex: 'mq', multiplier: inputs.psi2}, { ax: 'p1oo_ax', flex: 'p1oo_flex'}, { ax: 'p2oo_ax', flex: 'p2oo_flex'} ]);
        const stress5_sup2_kn = sumFiberStress('sup2', [ { ax: 'ng3', flex: 'mg3'}, { ax: 'nq', flex: 'mq', multiplier: inputs.psi2}, { ax: 'p1oo_ax', flex: 'p1oo_flex'}, { ax: 'p2oo_ax', flex: 'p2oo_flex'} ]);
        results.push({ inf: stress5_inf_kn * KN_M2_TO_TF_M2, sup1: stress5_sup1_kn * KN_M2_TO_TF_M2, sup2: stress5_sup2_kn * KN_M2_TO_TF_M2 });
        
        results.forEach((stress_tfm2, i) => {
            const limit = limits_tfm2[i];
            const checkFiber = (stressVal, limitVal) => {
                if (limitVal === null || stressVal === null || isNaN(stressVal) || isNaN(limitVal)) return true;
                const tolerance = 1e-2; 
                if (limitVal >= 0) { 
                    return stressVal <= limitVal + tolerance;
                } else { 
                    return stressVal >= limitVal - tolerance;
                }
            };
            const check_inf = checkFiber(stress_tfm2.inf, limit.inf);
            const check_sup1 = checkFiber(stress_tfm2.sup1, limit.sup1);
            const check_sup2 = checkFiber(stress_tfm2.sup2, limit.sup2);
            stress_tfm2.check = (check_inf && check_sup1 && check_sup2) ? '<span class="verification-ok">OK</span>' : '<span class="verification-fail">FALHA</span>';
        });

        return results;
    }


    // --- Funções de Atualização da Interface (UI) ---
    function populatePropertiesTable(properties) {
        updateElementText('area-inicial', formatNumber(properties.inicial.area, 3));
        updateElementText('yinf-inicial', formatNumber(properties.inicial.y_inf, 3));
        updateElementText('ysup-inicial', formatNumber(properties.inicial.y_sup, 3));
        updateElementText('inercia-inicial', formatNumber(properties.inicial.inertia, 5));
        updateElementText('winf-inicial', formatNumber(properties.inicial.w_inf, 4));
        updateElementText('wsup1-inicial', formatNumber(properties.inicial.w_sup1, 4));
        updateElementText('wsup2-inicial', formatNumber(properties.inicial.w_sup2, 4, true)); 
        updateElementText('area-final', formatNumber(properties.final.area, 3));
        updateElementText('yinf-final', formatNumber(properties.final.y_inf, 3));
        updateElementText('ysup-final', formatNumber(properties.final.y_sup, 3));
        updateElementText('inercia-final', formatNumber(properties.final.inertia, 5));
        updateElementText('winf-final', formatNumber(properties.final.w_inf, 4));
        updateElementText('wsup1-final', formatNumber(properties.final.w_sup1, 4));
        updateElementText('wsup2-final', formatNumber(properties.final.w_sup2, 4));
    }

    function populateLimitsTable(limits) {
        limits.forEach((limit, i) => {
            updateElementText(`limit-inf-${i}`, formatNumber(limit.inf, 0));
            updateElementText(`limit-sup1-${i}`, formatNumber(limit.sup1, 0));
            updateElementText(`limit-sup2-${i}`, formatNumber(limit.sup2, 0));
        });
    }

    function populateCalculatedStressesTable(combinedStresses) {
        combinedStresses.forEach((stress, i) => {
            updateElementText(`stress-inf-${i}`, formatNumber(stress.inf, 0));
            updateElementText(`stress-sup1-${i}`, formatNumber(stress.sup1, 0));
            updateElementText(`stress-sup2-${i}`, formatNumber(stress.sup2, 0));
            getElement(`check-${i}`).innerHTML = stress.check;
        });
    }

    function populateIndividualStressesTable(individualStresses_knm2_arg) { 
        const tbody = getElement('individual-stresses-tbody');
        tbody.innerHTML = '';
        const actionOrderAndNames = [
            { key_ax: 'p1o_ax', key_flex: 'p1o_flex', name_ax: 'N<sub>p1o</sub>', name_flex: 'M<sub>p1o</sub>' },
            { key_ax: 'p1oo_ax', key_flex: 'p1oo_flex', name_ax: 'N<sub>p1∞</sub>', name_flex: 'M<sub>p1∞</sub>' },
            { key_ax: 'p2o_ax', key_flex: 'p2o_flex', name_ax: 'N<sub>p2o</sub>', name_flex: 'M<sub>p2o</sub>' },
            { key_ax: 'p2oo_ax', key_flex: 'p2oo_flex', name_ax: 'N<sub>p2∞</sub>', name_flex: 'M<sub>p2∞</sub>' },
            { key_ax: 'ng1', key_flex: 'mg1', name_ax: 'N<sub>g1</sub>', name_flex: 'M<sub>g1</sub>' },
            { key_ax: 'ng2', key_flex: 'mg2', name_ax: 'N<sub>g2</sub>', name_flex: 'M<sub>g2</sub>' },
            { key_ax: 'ng3', key_flex: 'mg3', name_ax: 'N<sub>g3</sub>', name_flex: 'M<sub>g3</sub>' },
            { key_ax: 'nq', key_flex: 'mq', name_ax: 'N<sub>q</sub>', name_flex: 'M<sub>q</sub>' }
        ];
        actionOrderAndNames.forEach(action => {
            const addRow = (name, stressObj_knm2) => {
                if (!stressObj_knm2) return; 
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="table-cell font-medium">${name}</td>
                    <td class="table-cell text-right">${formatNumber(stressObj_knm2.inf !== null ? stressObj_knm2.inf * KN_M2_TO_TF_M2 : null, 0)}</td>
                    <td class="table-cell text-right">${formatNumber(stressObj_knm2.sup1 !== null ? stressObj_knm2.sup1 * KN_M2_TO_TF_M2 : null, 0)}</td>
                    <td class="table-cell text-right">${formatNumber(stressObj_knm2.sup2 !== null ? stressObj_knm2.sup2 * KN_M2_TO_TF_M2 : null, 0)}</td>`;
            };
            addRow(action.name_ax, individualStresses_knm2_arg[action.key_ax]);
            addRow(action.name_flex, individualStresses_knm2_arg[action.key_flex]);
        });
    }
    
    function updateCalculatedPrestressFieldsInActionsTab(prestressMoments, prestressForces) {
        updateElementValue('mp1o', formatNumber(prestressMoments.Mp1o, 1));
        updateElementValue('mp2o', formatNumber(prestressMoments.Mp2o, 1));
        updateElementValue('mp1oo', formatNumber(prestressMoments.Mp1oo, 1));
        updateElementValue('mp2oo', formatNumber(prestressMoments.Mp2oo, 1));
        updateElementValue('np1o', formatNumber(prestressForces.Np1o, 1));
        updateElementValue('np2o', formatNumber(prestressForces.Np2o, 1));
        updateElementValue('np1oo', formatNumber(prestressForces.Np1oo, 1));
        updateElementValue('np2oo', formatNumber(prestressForces.Np2oo, 1));
    }

    function populateUIWithResults(properties, limits, combinedStresses, individualStresses_arg, prestressMoments_tfm, prestressForces_tf, decompressionMoments_tfm) {
        populatePropertiesTable(properties);
        populateLimitsTable(limits);
        populateCalculatedStressesTable(combinedStresses);
        populateIndividualStressesTable(individualStresses_arg); 
        updateCalculatedPrestressFieldsInActionsTab(prestressMoments_tfm, prestressForces_tf);
        
        if (decompressionMoments_tfm) {
            updateElementText('result-md-inicial', formatNumber(decompressionMoments_tfm.Md1_tfm, 1));
            updateElementText('result-md-final', formatNumber(decompressionMoments_tfm.Md2_tfm, 1));
        } else {
            updateElementText('result-md-inicial', '-');
            updateElementText('result-md-final', '-');
        }
    }

    function updatePrestressForcesAndMomentsInActionsUI() {
        try {
            const inputs = getInputs(); 
            const properties = calculateGeometricProperties(inputs.geometry, inputs.bf1, inputs.hf1, inputs.bf2, inputs.hf2);
            const prestressForces = calculatePrestressForces(inputs); 
            const prestressMoments = calculatePrestressMoments(inputs, properties); 
            updateCalculatedPrestressFieldsInActionsTab(prestressMoments, prestressForces);
        } catch (error) {
            console.error("Erro ao atualizar forças/momentos de protensão na UI da aba Ações:", error);
            ['mp1o', 'mp2o', 'mp1oo', 'mp2oo', 'np1o', 'np2o', 'np1oo', 'np2oo'].forEach(id => updateElementValue(id, '-'));
        }
    }

    // --- Visualização da Seção (SVG) ---
    function drawSection() {
        const inputs = getInputs();
        try {
            const props = calculateGeometricProperties(inputs.geometry, inputs.bf1, inputs.hf1, inputs.bf2, inputs.hf2);
            const svgWidth = 300, svgHeight = 250, padding = 20; 
            const maxGeoWidth = Math.max( ...inputs.geometry.map(el => Math.max(el.binf, el.bsup)), inputs.bf1, inputs.bf2, 0.1 ); 
            const totalHeight = props.final.h_total;

            if (maxGeoWidth <= 1e-9 || totalHeight <= 1e-9 || !isFinite(maxGeoWidth) || !isFinite(totalHeight)) {
                visualizationDiv.innerHTML = '<span class="text-sm italic">Dimensões inválidas para desenho.</span>'; return;
            }

            const scaleX = (svgWidth - 2 * padding) / maxGeoWidth;
            const scaleY = (svgHeight - 2 * padding) / totalHeight;
            const scale = Math.min(scaleX, scaleY) * 0.9; 

            const scaledTotalWidth = maxGeoWidth * scale;
            const offsetX = (svgWidth - scaledTotalWidth) / 2; 
            const offsetY = svgHeight - padding; 

            let svgContent = `<svg width="${svgWidth}" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="${svgWidth}" height="${svgHeight}" fill="#f9fafb"/>`;
            let currentY_base_drawing_m = 0; 

            inputs.geometry.forEach((el, index) => {
                if (el.h <= 0) return;
                const y_bottom_el_m = currentY_base_drawing_m;
                const y_top_el_m = currentY_base_drawing_m + el.h;
                const y_bottom_el_svg = offsetY - y_bottom_el_m * scale;
                const y_top_el_svg = offsetY - y_top_el_m * scale;
                const x_offset_inf_el = (maxGeoWidth - el.binf) / 2; 
                const x_offset_sup_el = (maxGeoWidth - el.bsup) / 2;

                const points = `
                    ${offsetX + x_offset_inf_el * scale},${y_bottom_el_svg}
                    ${offsetX + (x_offset_inf_el + el.binf) * scale},${y_bottom_el_svg}
                    ${offsetX + (x_offset_sup_el + el.bsup) * scale},${y_top_el_svg}
                    ${offsetX + x_offset_sup_el * scale},${y_top_el_svg}
                `;
                svgContent += `<polygon points="${points.trim()}" fill="#d1d5db" stroke="#6b7280" stroke-width="0.5"/>`;
                svgContent += `<text x="${padding / 2}" y="${(y_top_el_svg + y_bottom_el_svg) / 2}" class="element-number">${index + 1}</text>`;
                currentY_base_drawing_m += el.h;
            });

            const drawLayer = (h_layer, b_layer, y_base_layer_m, color) => {
                if (h_layer <= 0 || b_layer <= 0) return;
                const y_bottom_layer_m = y_base_layer_m;
                const y_top_layer_m = y_base_layer_m + h_layer;
                const y_bottom_layer_svg = offsetY - y_bottom_layer_m * scale;
                const y_top_layer_svg = offsetY - y_top_layer_m * scale;
                const x_offset_layer = (maxGeoWidth - b_layer) / 2;
                svgContent += `<rect x="${offsetX + x_offset_layer * scale}" y="${y_top_layer_svg}" width="${b_layer * scale}" height="${h_layer * scale}" fill="${color}" stroke="#6b7280" stroke-width="0.5"/>`;
            };
            drawLayer(inputs.hf1, inputs.bf1, props.inicial.h_total, "#e5e7eb"); 
            drawLayer(inputs.hf2, inputs.bf2, props.inicial.h_total + inputs.hf1, "#f3f4f6"); 

            const cg_radius = 2.5;
            const cg_center_x_svg = svgWidth / 2; 
            const drawCGCable = (cg_y_m, num_cables, color, label) => {
                if (num_cables > 0 && cg_y_m > 0 && cg_y_m <= totalHeight) {
                    const cg_y_svg = offsetY - cg_y_m * scale;
                    svgContent += `<circle cx="${cg_center_x_svg}" cy="${cg_y_svg}" r="${cg_radius}" fill="none" stroke="${color}" stroke-width="1"/>`;
                    svgContent += `<text x="${cg_center_x_svg + cg_radius + 2}" y="${cg_y_svg + cg_radius / 2}" fill="${color}" class="cg-label" text-anchor="start" dominant-baseline="middle">${label}</text>`;
                }
            };
            drawCGCable(inputs.cg_cables1, inputs.num_cables1, "red", "P1");
            drawCGCable(inputs.cg_cables2, inputs.num_cables2, "blue", "P2");

            svgContent += '</svg>';
            visualizationDiv.innerHTML = svgContent;
        } catch (error) {
            console.error("Erro ao desenhar seção:", error);
            visualizationDiv.innerHTML = '<span class="text-sm italic text-red-600">Erro ao desenhar. Verifique os dados.</span>';
        }
    }

    // --- Função Principal de Cálculo e Orquestração ---
    function performCalculations() {
        try {
            const inputs = getInputs(); 
            window.currentInputs = inputs; // Torna 'inputs' acessível globalmente para calculateDecompressionMoments

            const properties = calculateGeometricProperties(inputs.geometry, inputs.bf1, inputs.hf1, inputs.bf2, inputs.hf2);
            const limitStresses_tfm2 = calculateLimitStresses(inputs);
            
            const prestressForces_tf = calculatePrestressForces(inputs); 
            const prestressMoments_tfm = calculatePrestressMoments(inputs, properties); 

            const localIndStresses = calculateIndividualStresses(inputs, properties); 
            
            const decompressionMoments_tfm = calculateDecompressionMoments(inputs, properties, localIndStresses); 
            
            const combinedStresses_tfm2 = calculateCombinedStressesAndVerifications(inputs, limitStresses_tfm2); 

            populateUIWithResults(properties, limitStresses_tfm2, combinedStresses_tfm2, localIndStresses, prestressMoments_tfm, prestressForces_tf, decompressionMoments_tfm);
            
            drawSection(); 
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error("Erro nos cálculos:", error, error.stack);
            resultsSection.classList.add('hidden');
            visualizationDiv.innerHTML = '<span class="text-sm italic text-red-600">Erro ao calcular. Verifique console.</span>';
            const errorBox = document.createElement('div');
            errorBox.style.cssText = 'position:fixed; left:50%; top:50%; transform:translate(-50%, -50%); background-color:white; padding:20px; border:1px solid red; border-radius:8px; box-shadow:0 4px 6px rgba(0,0,0,0.1); z-index:1000; max-width: 90%; text-align: left;';
            errorBox.innerHTML = `<p style="color: red; font-weight: bold; margin-bottom: 10px;">Erro nos Cálculos</p>
                                <p>Ocorreu um erro durante o processamento. Verifique se todos os dados de entrada estão corretos e tente novamente. Para mais detalhes, verifique o console do navegador (geralmente acessível com F12).</p>
                                <p style="font-size:0.8em; margin-top:5px; color: #555;">Detalhe técnico: ${error.message}</p>
                                <button onclick="this.parentElement.remove()" style="margin-top: 15px; padding: 8px 16px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; display: block; margin-left: auto; margin-right: auto;">Fechar</button>`;
            document.body.appendChild(errorBox);
        }
    }

    // --- Inicialização da Calculadora ---
    function initializeCalculator() {
        geometryTbody = getElement('geometry-tbody');
        addRowBtn = getElement('add-row-btn');
        removeRowBtn = getElement('remove-row-btn');
        calculateBtn = getElement('calculate-btn');
        resultsSection = getElement('results-section');
        visualizationDiv = getElement('section-visualization');
        tabButtons = querySelectorAll('.tab-button');
        stepContents = [getElement('tab-content-geometria'), getElement('tab-content-materiais'), getElement('tab-content-acoes')];
        prevBtn = getElement('prev-btn');
        nextBtn = getElement('next-btn');

        geometryTbody.innerHTML = '';
        addGeometryRow(0.780, 0.780, 0.350); addGeometryRow(0.780, 0.220, 0.280);
        addGeometryRow(0.220, 0.220, 1.620); addGeometryRow(0.220, 1.300, 0.030);
        addGeometryRow(1.300, 1.300, 0.120);

        updateElementValue('bf1', "1.00"); updateElementValue('hf1', "0.11");
        updateElementValue('bf2', "4.250"); updateElementValue('hf2', "0.14");
        updateElementValue('fckj_ato', "3500"); updateElementValue('fckj_servico', "3500"); 
        updateElementValue('fck28', "4500"); updateElementValue('alpha', "1.2");
        updateElementValue('cg_cables1', "0.209"); updateElementValue('num_cables1', "46");
        updateElementValue('po1', "21.1"); updateElementValue('pinf1', "17.8");
        updateElementValue('ato_percentage', "100");
        updateElementValue('cg_cables2', "0.0"); updateElementValue('num_cables2', "0");
        updateElementValue('po2', "0.0"); updateElementValue('pinf2', "0.0");
        updateElementValue('mg1', "377.0"); updateElementValue('mg2', "412.0");
        updateElementValue('mg3', "203.0"); updateElementValue('mq', "557.0");
        updateElementValue('psi1', "0.50"); updateElementValue('psi2', "0.30");
        updateElementValue('ng1', "0.0"); updateElementValue('ng2', "0.0");
        updateElementValue('ng3', "0.0"); updateElementValue('nq', "0.0");

        addRowBtn.addEventListener('click', () => { addGeometryRow(); updatePrestressForcesAndMomentsInActionsUI(); drawSection(); });
        removeRowBtn.addEventListener('click', removeGeometryRow); 
        calculateBtn.addEventListener('click', performCalculations);

        const inputsForDynamicUpdate = document.querySelectorAll('.prestress-input, #bf1, #hf1, #bf2, #hf2');
        inputsForDynamicUpdate.forEach(input => {
            input.addEventListener('input', () => {
                updatePrestressForcesAndMomentsInActionsUI();
                drawSection(); 
            });
        });
        
        updatePrestressForcesAndMomentsInActionsUI();
        drawSection();
        goToStep(1); 
    }

    document.addEventListener('DOMContentLoaded', initializeCalculator);
</script>
</body>
</html>
